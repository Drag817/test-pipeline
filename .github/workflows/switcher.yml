name: Switch production instance

on:
  push:
    branches: [ "master" ] # delete in prod
  workflow_dispatch:

jobs:
  get-active:
    runs-on: "0" # change to "dev"
    outputs:
      active: ${{ steps.group-info.outputs.active }}
    steps:
      - name: install jq (yq)
        run: sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq

      - name: yc setup
        uses: nightstory/setup-yc@v1
        with:
          enable-cache: true

      - name: Get group info
        id: group-info
        run: echo "active=$(yc alb backend-group get production | yq '.["http"]["backends"][0]["backend_weight"]')" >> "$GITHUB_OUTPUT" # change "production" to <backend-group name>

  switch-instance:
    needs: get-active
    runs-on: "0" # change to "dev"
    steps:
      - name: install jq (yq)
        run: sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq

      - name: yc setup
        uses: nightstory/setup-yc@v1
        with:
          enable-cache: true

      - name: if secondary active
        if: ${{ needs.get-active.outputs.active == 0 }}
        run: | # need to change instance name in last string
          yc compute instance stop prod-2 && yc compute instance update prod-2 --memory 12 --cores 6 && yc compute instance start prod-2
          sleep 120
          yc alb backend-group update-http-backend --backend-group-name production --name primary --weight 100 && yc alb backend-group update-http-backend --backend-group-name production --name secondary --weight 0
          sleep 180
          yc compute instance stop prod-2 && yc compute instance update prod-2 --memory 4 --cores 2 && yc compute instance start prod-2

      - name: if primary active # only for examle
        if: ${{ needs.get-active.outputs.active == 100 }}
        run: |
          yc compute instance stop prod-2 && yc compute instance update prod-2 --memory 12 --cores 6 && yc compute instance start prod-2
          sleep 120
          yc alb backend-group update-http-backend --backend-group-name production --name primary --weight 100 && yc alb backend-group update-http-backend --backend-group-name production --name secondary --weight 0
          sleep 180
          yc compute instance stop prod-2 && yc compute instance update prod-2 --memory 4 --cores 2 && yc compute instance start prod-2
